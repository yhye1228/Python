import cv2
import numpy as np
import matplotlib.pyplot as plt
from keras_facenet import FaceNet

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1ï¸âƒ£ ì„ë² ë” ìƒì„±
embedder = FaceNet()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2ï¸âƒ£ ë‚´ ì–¼êµ´ ì´ë¯¸ì§€ ë¡œë“œ & ì„ë² ë”©
my_images = []
labels = []  # ë‚´ ì–¼êµ´ = 1, íƒ€ì¸ = 0
for i in range(10):
    file = f"./my_images/img{i+1:02d}.jpg"
    img = cv2.imread(file)
    if img is None:
        print(f"âš ï¸ {file} ë¡œë“œ ì‹¤íŒ¨")
        continue
    img = cv2.resize(img, (160, 160))  # ğŸ”¥ FaceNet ì…ë ¥ í¬ê¸°: (160, 160, 3)
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    my_images.append(img)
    labels.append(1)

X_my = np.array(my_images, dtype='float32')
embeddings_my = embedder.embeddings(X_my)
mean_embedding_my = np.mean(embeddings_my, axis=0, keepdims=True)

print("âœ… ë‚´ ì–¼êµ´ ì„ë² ë”© ê³„ì‚° ì™„ë£Œ")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3ï¸âƒ£ í…ŒìŠ¤íŠ¸ ì´ë¯¸ì§€ ë¡œë“œ & ë¹„êµ
test_images = []
for i in range(10):
    file = f"./test_images/img{i+1:02d}.jpg"
    img = cv2.imread(file)
    if img is None:
        print(f"âš ï¸ {file} ë¡œë“œ ì‹¤íŒ¨")
        continue
    img = cv2.resize(img, (160, 160))   # âœ… ëª¨ë“  ì´ë¯¸ì§€ë¥¼ (160,160)ìœ¼ë¡œ ë§ì¶”ê¸°
    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB)
    test_images.append(img)

X_test = np.array(test_images, dtype='float32')
embeddings_test = embedder.embeddings(X_test)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4ï¸âƒ£ ìœ ì‚¬ë„(ì½”ì‚¬ì¸) ê³„ì‚° & íŒë³„
from sklearn.metrics.pairwise import cosine_similarity

for i, emb in enumerate(embeddings_test):
    sim = cosine_similarity(mean_embedding_my, emb.reshape(1, -1))[0][0]
    if sim > 0.7:
        print(f"img{i+1:02d}.jpg â†’ âœ… ë‚´ ì–¼êµ´ (ìœ ì‚¬ë„ {sim:.3f})")
    else:
        print(f"img{i+1:02d}.jpg â†’ âŒ íƒ€ì¸ (ìœ ì‚¬ë„ {sim:.3f})")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5ï¸âƒ£ ì‹œê°í™” (ì„ íƒ)
def show_images(images, title=""):
    plt.figure(figsize=(8,4))
    cols = 5
    for idx, im in enumerate(images):
        plt.subplot((len(images)+cols-1)//cols, cols, idx+1)
        plt.imshow(im)
        plt.axis('off')
    plt.suptitle(title)
    plt.show()

show_images(my_images, "my_images")
show_images(test_images, "test_images")
